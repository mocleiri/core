<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Wicket Stuff Wiki : How to use PersistenceUnit annotation</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Wicket Stuff Wiki : How to use PersistenceUnit annotation
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jun 24, 2010 by <font color="#0050B2">aldaris</font>.
				    </div>

				    <p>How to use @PersistenceUnit? annotation in your wicket page</p>

<p><b>Beware&#33;</b> Due to classloading limitations for entities, you cannot mix the usage of @PersistenceUnit and @EJB to persist your entities. So you have to choose only one of these approaches in your application.</p>

<p>1. Develop a Java EE 5 entity, i.e.<br clear="all" />
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>@Entity
public class Contact {

  private Long id;
  private String name;
  private String email;

  public Contact() {}

  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  public Long getId() {
    return id;
  }
  public void setId(Long id) {
    this.id = id;
  }
  //other setters, getters, equals and hashCode follows
}
</pre>
</div></div><br clear="all" />
2. Create a persistence.xml file, i.e.
<br clear="all" /> <br clear="all" />
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence" version="1.0"&gt;
 &lt;persistence-unit name="defaultPersistenceUnit" transaction-type="JTA"&gt;
 &lt;jta-data-source&gt;jdbc/__default&lt;/jta-data-source&gt;
 &lt;class&gt;wicket.javaee.model.Contact&lt;/class&gt;
 &lt;properties&gt;
 &lt;property name="toplink.platform.class.name"
 value="oracle.toplink.essentials.platform.database.DerbyPlatform"/&gt;
  &lt;property name="toplink.ddl-generation" value="drop-and-create-tables"/&gt;
  &lt;property name="toplink.create-ddl-jdbc-file-name" value="create.jdbc"/&gt;
  &lt;property name="toplink.drop-ddl-jdbc-file-name" value="drop.jdbc"/&gt;
 &lt;/properties&gt;
 &lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre>
</div></div><br clear="all" />
3. Create your wicket page using the @PersistenceUnit annotation to refer to the EntityManagerFactory, i.e.
<br clear="all" /> <br clear="all" />
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>public class ListContacts extends WebPage {
  @PersistenceUnit(unitName="defaultPersistenceUnit") private EntityManagerFactory emf;

  public ListContacts() {
    new ListView&lt;Contact&gt;(this, "contacts",getContacts()){
      protected void populateItem(final ListItem&lt;Contact&gt; item) {
	new Label(item, "name", new PropertyModel(item.getModel(), "name"));
	new Link(item, "delete", item.getModel()) {
	  public void onClick() {
	    EntityManager entityManager = emf.createEntityManager();
	    entityManager.getTransaction().begin();
	    Contact managed = entityManager.merge(item.getModelObject());
	    entityManager.remove(managed);
	    entityManager.getTransaction().commit();
	    entityManager.close();
	    setResponsePage(new ListContacts());
	  }
	};
      };
    }

  private List&lt;Contact&gt; getContacts() {
    EntityManager entityManager = emf.createEntityManager();
    List contacts = entityManager.createQuery("select c from Contact c").getResultList();
    entityManager.close();
    return contacts;
  }
}
</pre>
</div></div><br clear="all" />
4. Add the line
<br clear="all" /> <br clear="all" />
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>addComponentInstantiationListener(new JavaEEComponentInjector(this));
</pre>
</div></div><br clear="all" />
inside the <b>init()</b> method of your Wicket WebApplication?, like in the example:
<br clear="all" /> <br clear="all" />
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>public class WicketJavaEEApplication extends WebApplication {

   protected void init() {
      addComponentInstantiationListener(new JavaEEComponentInjector(this));
   }
}
</pre>
</div></div><br clear="all" />
5. Package your application in a single war file
<br clear="all" /></p>

<p>Note:</p>

<p>I found that Glassfish complained about getting the transaction from the entity manage. To solve thisI found injecting the user transaction resource worked. This may not be the 'correct' way, but it seems to match how the JPA in a web app tutorial example. <a href="http://java.sun.com/javaee/5/docs/tutorial/doc/bnbrm.html">http://java.sun.com/javaee/5/docs/tutorial/doc/bnbrm.html</a></p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>public class ListContacts extends WebPage {Â   @Resource(name="java:comp/env/UserTransaction")
  UserTransaction utx;

  @PersistenceUnit(unitName="defaultPersistenceUnit") private EntityManagerFactory emf;

  public ListContacts() {
    new ListView&lt;Contact&gt;(this, "contacts",getContacts()){
      protected void populateItem(final ListItem&lt;Contact&gt; item) {
	new Label(item, "name", new PropertyModel(item.getModel(), "name"));
	new Link(item, "delete", item.getModel()) {
	  public void onClick() {
	    EntityManager entityManager = emf.createEntityManager();
	    utx.begin();
	    Contact managed = entityManager.merge(item.getModelObject());
	    entityManager.remove(managed);
	    utx.commit();
	    entityManager.close();
	    setResponsePage(new ListContacts());
	  }
	};
      };
    }

  private List&lt;Contact&gt; getContacts() {
    EntityManager entityManager = emf.createEntityManager();
    List contacts = entityManager.createQuery("select c from Contact c").getResultList();
    entityManager.close();
    return contacts;
  }
}
</pre>
</div></div>

				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://wicketstuff.org/confluence/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Apr 11, 2011 12:08</font></td>
		    </tr>
	    </table>
    </body>
</html>